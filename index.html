<html>
    <head>
        <title>Carnival-style pony-race drawing</title>
        <link type="text/css" rel="stylesheet" href="button.css">
        <link type="text/css" rel="stylesheet" href="charts.css">
        <link rel="stylesheet" href="libs/really-simple-color-picker/colorPicker.css" type="text/css" />
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script language="javascript" type="text/javascript"
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script language="javascript" type="text/javascript"
                src="libs/really-simple-color-picker/jquery.colorPicker.min.js"/></script>
        
        <style>
            .jockey:hover {
                text-decoration: line-through;}
        </style>
    </head>
    <body>
        <h1>Pony Race!</h1>
              <div id="inputs">
                  <input type="text" id="name" value="Adam">
                  <input type="text" id="num" value="3">
                  <input id="color1" type="text" name="color1" value="#333399"
                  />
                  <button class="add">Add</button>
              </div>

              <div id="jockey-list">
              </div>

              <div id="controls">
                  <button class="first last active">Go!</button>
                  <button class="first last active">Reset</button>
              </div>
           

              <div id="chart">
              </div>

        <script type="text/javascript">

// TODO Move script into separate JS function
// TODO Move pony updating code to separate functions
// TODO Record 1st, 2nd, 3rd so multiple winners can be picked
    // Add option to run all the way to end, give full ranking list
// TODO What should we do about adding ponies in the middle of a race?
// TODO Completely refactor code so it looks like I planned out the
    // implementation rather than just hacking it together ;)
// TODO Fix other TODO items below
// TODO Remove a color from picker once it has been used?
// TODO Add this into an expanded options section which is hidden by default
    // TODO Add option to switch between rect/pony/bike
    // TODO Add speed control/logic
        // Faster/slower

// Add color selector to documents
jQuery(document).ready(function($) {
   $('#color1').colorPicker();
})

var getRandomInt = function(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

var getStepSize = function() {
    return (90*ponies.length*50)/(10*1000);
}

var ponies = [];
var jockeys = [];

var nextPlace = 1;
var raceLength = 10; // Race length in seconds

var runPonies = function()
{
    if (running) {
        // Figure out which (if any) ponies haven't finished
        var notFinished = [];
        for (var i = 0; i < ponies.length; i++) {
            if (ponies[i].progress < 90) { 
                notFinished.push(i);
            }
        }
         
        // See if any of the ponies still need to finish
        if (notFinished.length > 0) {
            // Move a random (still running) pony forward and record if they
            // made it to the end
            var tmp = getRandomInt(0,notFinished.length-1);
            ponies[notFinished[tmp]].progress += getStepSize();
            if (ponies[notFinished[tmp]].progress >= 90)
            {
                ponies[notFinished[tmp]].finishPos = nextPlace++;
            }

            d3.selectAll('.pony').data(ponies)
                .transition().ease('linear').duration(50).attr('x',function(d) {
                        return x(d.progress); })
            setTimeout(runPonies,50);
        } else {
            // TODO Add nice winner pop-up
            d3.selectAll('#controls button').filter(function(d,i) { return i == 0;}).text('Done');
            done = true;
            running = false;
        }
    }
}

var addEntrant = function()
{
    var name = $('#name').val(),
        num = $('#num').val(),
        col = $('#color1').val();

    if (name.length > 0 && !isNaN(+num))
    {
        // Add the individual ponies and the jockey to the list
        for (var i = 0; i < +num; i++) {
            ponies.push({progress:0,
                    jockey:name,
                    col:col,
                    finishPos:0});
        }
        jockeys.push({name:name,num:num,col:col});
        y.domain([0,ponies.length]);

        // Add entry to text list of jockeys
        var jockeyList = d3.select('#jockey-list').selectAll('.jockey')
                .data(jockeys);
        jockeyList.enter()
                .append('p')
                .text(function(d) { return d.name + ' (' + d.num + ')'; }) 
                .classed('jockey',true)
                .style('color',function(d) { return d.col; })
            .on('click',function(d,i) { removeEntrant(i); });

        // Add new lanes for ponies
        var ponyLanes = d3.select('#data-region').selectAll('.pony-lane')
            .data(ponies);
        ponyLanes.enter()
                .append('svg:rect')
                .attr('height',y(.05)-y(0))
                .attr('x',x(10))
                .attr('width',x(90)-x(0))
                .attr('y',function(d,i) { return y(i+.5-.025); })
                .style('stroke','none')
                .classed('pony-lane',true)
                .style('fill',function(d) { return d.col;});

        // Update positions for existing lanes
        ponyLanes.transition().duration(100)
                .attr('y',function(d,i) { return y(i+.5-.025); })
                .attr('height',y(.050)-y(0));
                
        // Add new ponies
        var ponyList = d3.select('#data-region').selectAll('.pony')
                .data(ponies);
        ponyList.enter()
                .append('svg:rect')
                .attr('height',y(.5)-y(0))
                .attr('x',function(d) { return x(d.progress); })
                .attr('width',x(10)-x(0))
                .attr('y',function(d,i) { return y(i+.25); })
                .style('stroke','none')
                .classed('pony',true)
                .style('fill',function(d) { return d.col;});

        // Update positions for existing ponies
        ponyList.transition().duration(100)
                .attr('y',function(d,i) { return y(i+.25); })
                .attr('height',y(.50)-y(0));
    
    } else {
        // TODO Should popup a warning message
    }
}

var removeEntrant = function(i) {

    // Figure out which indexes we need to remove
    var toRemove = [];
    for (var j = 0; j < ponies.length; j++) {
        if (ponies[j].jockey == jockeys[i].name) {
            toRemove.push(j);
        }
    }

    // Remove them in reverse order so we don't have to do anything fancy with
    // indexes
    for (var j = toRemove.length-1; j > -1; j--)
    {
        ponies.splice(toRemove[j],1);
    }

    // Remove jockey's rects and move remaining ponies/fix y-scale 
    y.domain([0,ponies.length]);
    var ponyList = d3.select('#data-region').selectAll('.pony')
            .data(ponies);
    ponyList.transition().duration(100)
            .attr('y',function(d,i) { return y(i+.25); })
            .style('fill',function(d) { return d.col;})
            .attr('height',y(.50)-y(0));
    ponyList.exit().remove();

    var ponyLanes = d3.select('#data-region').selectAll('.pony-lane')
            .data(ponies);
    ponyLanes.transition().duration(100)
                .attr('height',y(.05)-y(0))
                .style('fill',function(d) { return d.col;})
                .attr('y',function(d,i) { return y(i+.5-.025); });
    ponyLanes.exit().remove();

    // Remove jockeys name from displayed list list
    jockeys.splice(i,1);
    var jockeyList = d3.select('#jockey-list').selectAll('.jockey')
            .data(jockeys)
        .text(function(d) { return d.name + ' (' + d.num + ')'; }) 
        .style('color',function(d) { return d.col; })
    jockeyList.exit().remove();
}

var resetPonies = function() {
    // Send the ponies back to the beginning
    for (var i = 0; i < ponies.length; i++)
    {
        ponies[i].progress = 0;
    }
    done = false;
    running = false;
    d3.selectAll('.pony').data(ponies)
        .transition().ease('linear').duration(250).attr('x',function(d) {
                return x(d.progress); })
    d3.selectAll('#controls button').filter(function(d,i) { return i ==
            0;}).text('Go!');
    nextPlace = 1;
}

var running = false;
var done = false;

var width = 900;
    height = 550;

var xmax = 100,
    ymax = 1;

var margins = [80, 100, 100, 30], mb = margins[0], ml = margins[1], mt = margins[2], mr = margins[3];
var w = width - (ml + mr),
    h = height - (mb + mt);
var x = d3.scale.linear().range([0, w]).domain([0,xmax]);
var y = d3.scale.linear().range([0, h]).domain([0,ymax]);

// Add chart SVG
var svg = d3.select('#chart').append('svg:svg')
    .attr('class', 'chart')
    .attr("width", width)
    .attr("height", height);
var plot = svg.append('g').attr('id','plot').attr('transform','translate('+ml+','+mt+')');
var dataRegion = plot.append('g').attr('id','data-region');

var controls = d3.selectAll('#controls button')
    .data(['Go !','Reset']);

// Deal with 'Go' button clicks
controls.filter(function(d,i) { return i == 0; })
    .on('click',function(w) {
        // Only run ponies if there is at least one to run!
        if (ponies.length > 0)
        {
            if (!running && !done) {
                running = true;
                d3.selectAll('#controls button').filter(function(d,i) { return i == 0;}).text('Pause');
                runPonies();
            } else if (!done) {
                running = false;
                d3.selectAll('#controls button').filter(function(d,i) { return i == 0;}).text('Go!');
            }
        }
        });

// Deal with 'Reset' button clicks
controls.filter(function(d,i) { return i == 1; })
    .on('click',function(w) {
        resetPonies();
        });

// Deal with add jockey button clicks
d3.selectAll('#inputs button')
    .data(['Add'])
    .on('click',function(w) {
        addEntrant();
        });

// Add the start and finish lines
d3.select('#data-region').selectAll('.border-line')
        .data([10, 100])
    .enter()
        .append('svg:line')
        .classed('border-line',true)
        .attr('x1',function(d) { return x(d); })
        .attr('x2',function(d) { return x(d); })
        .attr('y1',y(0))
        .attr('y2',y(ymax))
        .style('stroke','black')
        .style('stroke-dasharray','10,10');
        </script>
    </body>
</html>
