<html>
    <head>
        <title>Carnival-style pony-race drawing</title>
        <link type="text/css" rel="stylesheet" href="button.css">
        <link type="text/css" rel="stylesheet" href="charts.css">
        <link rel="stylesheet" href="libs/really-simple-color-picker/colorPicker.css" type="text/css" />
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script language="javascript" type="text/javascript"
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script language="javascript" type="text/javascript"
                src="libs/really-simple-color-picker/jquery.colorPicker.min.js"/></script>
        
    </head>
    <body>
        <h1>Pony Race!</h1>
              <div id="inputs">
                  <input type="text" id="name">
                  <input type="text" id="num">
                  <input id="color1" type="text" name="color1" value="#333399"
                  />
                  <button class="add">Add</button>
              </div>

              <div id="controls">
                  <button class="first last active">Go!</button>
              </div>
        <div id="chart">
        </div>
        <script type="text/javascript">

// TODO Add ability to remove participants
    // Do this by having names list with X's next to them
// TODO Remove a color from picker once it has been used?
// TODO Record 1st, 2nd, 3rd so multiple winners can be picked

// Add color selector to documents
jQuery(document).ready(function($) {
   $('#color1').colorPicker();
})

var getRandomInt = function(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

var nPonies = 0;
var progress = [];
var entrants = [];
var cols = [];

var runPonies = function()
{
    // TODO Add ability to pause
    if (running) {
        if (Math.max.apply(Math,progress) < 90) {
            var tmp = getRandomInt(0,nPonies-1);
            progress[tmp] += 1
            d3.selectAll('.pony').data(progress)
                .transition().ease('linear').duration(50).attr('x',function(d) { return x(d); })
            setTimeout(runPonies,50);
        } else {
            console.log('Winner!');
            running = false;
        }
    }
}

var addEntrant = function()
{
    var name = $('#name').val(),
        num = $('#num').val(),
        col = $('#color1').val();

    // TODO Error check to make sure we have a name and that
    // num is actually a number

    for (var i = 0; i < +num; i++) {
        progress.push(0);
        entrants.push(name);
        cols.push(col);
    }
    nPonies = nPonies + +num;
    ymax = nPonies + 1;
    y.domain([0,ymax]);
    d3.select('.y.axis').transition().duration(500).call(yAxis);

    // Update positions for existing ponies
    var ponies = d3.select('#data-region').selectAll('.pony')
            .data(progress);
    ponies.transition().duration(100)
            .attr('y',function(d,i) { return y(i+1.25); })
            .attr('height',y(0)-y(.5));
            
    // Add new ponies
    ponies.enter()
            .append('svg:rect')
            .attr('height',y(0)-y(.5))
            .attr('x',function(d) { return x(d); })
            .attr('width',x(10)-x(0))
            .attr('y',function(d,i) { return y(i+1.25); })
            .style('stroke','none')
            .classed('pony',true)
            .style('fill',function(d,i) { return cols[i];});

    ponies.exit().remove();
    
    console.log('Adding entrant ' + name + ' ' + num + ' times');
}

var running = false;

var width = 900;
    height = 650;

var xmax = 100,
    ymax = nPonies + 1;

var margins = [80, 100, 100, 30], mb = margins[0], ml = margins[1], mt = margins[2], mr = margins[3];
var w = width - (ml + mr),
    h = height - (mb + mt);
var x = d3.scale.linear().range([0, w]).domain([0,xmax]);
var y = d3.scale.linear().range([h, 0]).domain([0,ymax]);
var xAxis = d3.svg.axis().scale(x).tickValues([]);
var yAxis = d3.svg.axis().scale(y).orient("left");

// Add chart SVG
var svg = d3.select('#chart').append('svg:svg')
    .attr('class', 'chart')
    .attr("width", width)
    .attr("height", height);
var plot = svg.append('g').attr('id','plot').attr('transform','translate('+ml+','+mt+')');
var dataRegion = plot.append('g').attr('id','data-region');

plot.append("g")
      .attr("class", "y axis")
      .call(yAxis);

plot.append("g")
    .attr("class", "x axis")
    .attr('transform','translate(0,'+h+') ')
    .call(xAxis);


d3.selectAll('#controls button')
    .data(['Go !'])
    .on('click',function(w) {
        running = true;
        runPonies();
        });

d3.selectAll('#inputs button')
    .data(['Add'])
    .on('click',function(w) {
        addEntrant();
        });

d3.select('#data-region').selectAll('.border-line')
        .data([10, 100])
    .enter()
        .append('svg:line')
        .classed('border-line',true)
        .attr('x1',function(d) { return x(d); })
        .attr('x2',function(d) { return x(d); })
        .attr('y1',y(0))
        .attr('y2',y(ymax))
        .style('stroke','black')
        .style('stroke-dasharray','10,10');

d3.select('#data-region').selectAll('.ponie')
        .data(progress)
    .enter()
        .append('svg:rect')
        .attr('height',y(0)-y(.5))
        .attr('x',function(d) { return x(d); })
        .attr('width',y(10))
        .attr('y',function(d,i) { return y(i+1.25); })
        .style('stroke','none')
        .classed('racebar',true)
        .style('fill','green');
        
        </script>
    </body>
</html>
