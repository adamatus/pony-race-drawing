<html>
    <head>
        <title>Carnival-style pony-race drawing</title>
        <link type="text/css" rel="stylesheet" href="button.css">
        <link type="text/css" rel="stylesheet" href="charts.css">
        <link rel="stylesheet" href="libs/really-simple-color-picker/colorPicker.css" type="text/css" />
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script language="javascript" type="text/javascript"
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script language="javascript" type="text/javascript"
                src="libs/really-simple-color-picker/jquery.colorPicker.min.js"/></script>
        
        <style>
            .jockey:hover {
                text-decoration: line-through;}
        </style>
    </head>
    <body>
        <h1>Pony Race!</h1>
              <div id="inputs">
                  <input type="text" id="name">
                  <input type="text" id="num">
                  <input id="color1" type="text" name="color1" value="#333399"
                  />
                  <button class="add">Add</button>
              </div>

              <div id="jockey-list">
              </div>

              <div id="controls">
                  <button class="first last active">Go!</button>
              </div>

              <div id="chart">
              </div>

        <script type="text/javascript">

// TODO Move pony updating code to separate functions
// TODO Add ability to remove participants
    // Do this by having names list with X's next to them or strike-throughs
    // on hover
// TODO Record 1st, 2nd, 3rd so multiple winners can be picked
    // Add option to run all the way to end, give full ranking list
// TODO Add reset button to send ponies back to start
// TODO Fix nameis conventions: ponies/horses, entrants/jockeys
// TODO Completely refactor code so it looks like I planned out the
    // implementation rather than just hacking it together ;)
// TODO Fix other TODO items below
// TODO Remove a color from picker once it has been used?

// Add color selector to documents
jQuery(document).ready(function($) {
   $('#color1').colorPicker();
})

var getRandomInt = function(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

var ponies = [];
var jockeys = [];

var runPonies = function()
{
    // TODO Add ability to pause
    if (running) {
        var maxProgress = -1;
        for (var i = 0; i < ponies.length; i++) {
            maxProgress = ponies[i].progress > maxProgress ? ponies[i].progress
                : maxProgress;
        }
         
        if (maxProgress < 90) {
            var tmp = getRandomInt(0,ponies.length-1);
            ponies[tmp].progress += 1
            d3.selectAll('.pony').data(ponies)
                .transition().ease('linear').duration(50).attr('x',function(d) {
                        return x(d.progress); })
            setTimeout(runPonies,50);
        } else {
            // TODO Add nice winner pop-up
            console.log('Winner!');
            running = false;
        }
    }
}

var addEntrant = function()
{
    var name = $('#name').val(),
        num = $('#num').val(),
        col = $('#color1').val();

    if (name.length > 0 && !isNaN(+num))
    {
        for (var i = 0; i < +num; i++) {
            ponies.push({progress:0,jockey:name,col:col});
        }
        jockeys.push({name:name,num:num,col:col});
        y.domain([0,ponies.length]);

        // Add entry to text list of jockeys
        var jockeyList = d3.select('#jockey-list').selectAll('.jockey')
                .data(jockeys);
        jockeyList.enter()
                .append('p')
                .text(function(d) { return d.name + ' (' + d.num + ')'; }) 
                .classed('jockey',true)
                .style('color',function(d) { return d.col; })
            .on('click',function(d,i) { removeEntrant(i); });
            

        // Update positions for existing ponies
        var ponyList = d3.select('#data-region').selectAll('.pony')
                .data(ponies);
        ponyList.transition().duration(100)
                .attr('y',function(d,i) { return y(i+.25); })
                .attr('height',y(.50)-y(0));
                
        // Add new ponies
        ponyList.enter()
                .append('svg:rect')
                .attr('height',y(.5)-y(0))
                .attr('x',function(d) { return x(d.progress); })
                .attr('width',x(10)-x(0))
                .attr('y',function(d,i) { return y(i+.25); })
                .style('stroke','none')
                .classed('pony',true)
                .style('fill',function(d) { return d.col;});
    
        console.log('Adding entrant ' + name + ' ' + num + ' times');
    } else {
        console.log('Bad data, not adding anything');
        // TODO Should popup a warning message
    }
}

var removeEntrant = function(i) {
    console.log('Need to remove entrant w/ uniqueEntrant index ' + i);
    // TODO Remove jockey entries from entrants, progress, uniqueEntrants, cols
    // TODO Remove jockeys rects and move remaining ponies/fix axis

    // Remove jockeys name from displayed list list
    // TODO Fix so that colors are correct
        // Need to include colors in data for jockeys
    uniqueEntrants.splice(i,1);
    var jockeys = d3.select('#jockey-list').selectAll('.jockey')
            .data(uniqueEntrants)
        .text(function(d) { return d; });
    jockeys.exit().remove();
}

var running = false;

var width = 900;
    height = 650;

var xmax = 100,
    ymax = 1;

var margins = [80, 100, 100, 30], mb = margins[0], ml = margins[1], mt = margins[2], mr = margins[3];
var w = width - (ml + mr),
    h = height - (mb + mt);
var x = d3.scale.linear().range([0, w]).domain([0,xmax]);
var y = d3.scale.linear().range([0, h]).domain([0,ymax]);

// Add chart SVG
var svg = d3.select('#chart').append('svg:svg')
    .attr('class', 'chart')
    .attr("width", width)
    .attr("height", height);
var plot = svg.append('g').attr('id','plot').attr('transform','translate('+ml+','+mt+')');
var dataRegion = plot.append('g').attr('id','data-region');

d3.selectAll('#controls button')
    .data(['Go !'])
    .on('click',function(w) {
        running = true;
        runPonies();
        });

d3.selectAll('#inputs button')
    .data(['Add'])
    .on('click',function(w) {
        addEntrant();
        });

d3.select('#data-region').selectAll('.border-line')
        .data([10, 100])
    .enter()
        .append('svg:line')
        .classed('border-line',true)
        .attr('x1',function(d) { return x(d); })
        .attr('x2',function(d) { return x(d); })
        .attr('y1',y(0))
        .attr('y2',y(ymax))
        .style('stroke','black')
        .style('stroke-dasharray','10,10');
        </script>
    </body>
</html>
