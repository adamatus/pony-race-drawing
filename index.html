<html>
    <head>
        <title>Carnival-style pony-race drawing</title>
        <link type="text/css" rel="stylesheet" href="button.css">
        <link type="text/css" rel="stylesheet" href="charts.css">
        <link rel="stylesheet" type="text/css" href="libs/jquery-simplecolorpicker/jquery.simplecolorpicker.css"/>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">

        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script language="javascript" type="text/javascript" src="pony-race.js"></script>
        <script language="javascript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <script language="javascript" type ="text/javascript" src="libs/jquery-simplecolorpicker/jquery.simplecolorpicker.js"></script>
        
        <style>
svg { 
    background: green;
    border:2px solid;
    border-radius: 30px;
    box-shadow: 5px 5px 10px #999999;
}

#left-col {
    width: 200px;
    float: left;
}

#right-col {
    margin-left: 200px;
    position: relative;
}

.clear { 
    clear: both;
}

#name {
    width: 100px;
}

.jockey-name {
    width: 100px;
}

.jockey-num {
    width: 20px;
}

.jockey-col {
    width: 20px;
}

#inputs-text {
   width: 130px;
   float: left;
}

#center-add-button {
    display: inline;
}

#inputs-other {
   margin-left: 130px;
}

#adv-options { 
    margin-top: 10px;
    margin-left: 10px;
    margin-right: 10px;
    padding-top: 10px;
    border-top: 1px solid black;
    text-align: center;
}

#controls { 
    margin-top: 10px;
    margin-left: 10px;
    margin-right: 10px;
    padding-top: 10px;
    border-top: 1px solid black;
    text-align: center;
}

.edited-input {
    color: black;
}

.default-input {
    color: #999;
}

#add-jockey,
.jockey-remove {
    cursor: pointer;
}

#adv-options-expand {
    display: none;
}
        </style>
    </head>
    <body>
        <h1>Pony Race!</h1>
          <div id="container">
            <div id="left-col">
              <div id="jockey-list">
                  <h2>Jockeys</h2>
              </div>
              <div id="inputs">
                  <div id="inputs-text">
                      <input type="text" id="name" class="jockey-name
                      default-input"
                      value="Jockey"/>
                      <input type="text" id="num" class="jockey-num
                      default-input" value="#"/>
                  </div>
                  <div id="inputs-other">
                    <select name="colorpicker" id="colorpicker">
                      <!-- Colors from ColorBrewer2.org  -->
                      <option value="#1F78B4">Blue</option>
                      <option value="#33A02C">Green</option>
                      <option value="#E31A1C">Red</option>
                      <option value="#FF7F00">Orange</option>
                      <option value="#6A3D9A">Purple</option>
                      <option value="#A6CEE3">Light Blue</option>
                      <option value="#B2DF8A">Light Green</option>
                      <option value="#FB9A99">Light Red</option>
                      <option value="#FDBF6F">Light Orange</option>
                      <option value="#CAB2D6">Light Purple</option>
                    </select>
                      <span id="add-jockey" onclick="addEntrant()">+</span>
                  </div>
                  <div class="clear"></div>
              </div>
              <div id="adv-options">
                  <span onclick="expandAdvOptions()" id="adv-options-title">+ Show Advanced Options</span>
                  <div id="adv-options-expand">
                      Speed: <input type="range" id="race-speed" name="race-speed" min="0" max="20"
                      value="10" onChange="updateSpeed()">
                  </div>
              </div>
              <div id="controls">
                  <button class="first last">Go!</button>
                  <button class="first last">Reset</button>
              </div>
            </div>
            <div id="right-col">

              <div id="chart">
              </div>

              <div id="winner-list" title="Race Results">
              </div>
            </div>
            <div class="clear"></div>
          </div>

        <script type="text/javascript">
var colorList = [{value:"#1F78B4", name:'Blue', active:1},
                {value:"#33A02C", name:'Green', active:1},
                {value:"#E31A1C", name:'Red', active:1},
                {value:"#FF7F00", name:'Orange', active:1},
                {value:"#6A3D9A", name:'Purple', active:1},
                {value:"#A6CEE3", name:'Light Blue', active:1},
                {value:"#B2DF8A", name:'Light Green', active:1},
                {value:"#FB9A99", name:'Light Red', active:1},
                {value:"#FDBF6F", name:'Light Orange', active:1},
                {value:"#CAB2D6", name:'Light Purple', active:1}];


var updatePicker = function() {
    // Add the color picker
    $('select[name="colorpicker"]').empty();
    var firstCol = '';
    for (var i = 0; i < colorList.length; i++) {
        if (colorList[i].active) {
            if (firstCol == '') {
                firstCol = colorList[i].value;
            }
            var option = $('<option></option')
                    .attr("value",colorList[i].value)
                    .text(colorList[i].name);
            $('select[name="colorpicker"]').append(option);
        }
    }

    $('select[name="colorpicker"]').simplecolorpicker();
    $('select[name="colorpicker"]').simplecolorpicker('selectColor',firstCol);
    $('select[name="colorpicker"]').simplecolorpicker('destroy');
    $('select[name="colorpicker"]').simplecolorpicker({picker: true});
};

updatePicker();

// Have default values in form disappear on focus
// From http://stackoverflow.com/a/12876076
var formDefaulter=function(){
    //Class to hold each form element
    var FormElement=function(element){
        var that=this;
        this.element=element;

        var initialVal=this.element.val();
        var isEdited=false;

        this.element.focus(function(){clearBox()});
        this.element.blur(function(){fillBox()});

        var clearBox=function(){
            if(!isEdited){
                that.element.val("");
                that.element.addClass("edited-input");
                that.element.removeClass("default-input");
                isEdited=true;
            }
        }
        var fillBox=function(){
            if(that.element.val()==""){
                that.element.val(initialVal);
                that.element.removeClass("edited-input");
                that.element.addClass("default-input");
                isEdited=false;
            }
        }
    }

    var add=function(elementId){
        new FormElement($('#'+elementId));
    }

    return{
        add:add
    }
}();

$(function(){
    formDefaulter.add('name');
    formDefaulter.add('num');
});

var updateSpeed = function() {
    raceLength = 21-$('#race-speed').val();
    console.log(raceLength);
}

var ponies = [];
var jockeys = [];

var nextPlace = 1;
var raceLength = 10; // Race length in seconds

var running = false;
var done = false;
var allowChanging = true;
var advOptionsHidden = true;

var width = $(window).width()-275;
    height = $(window).height()-150;

var xmax = 110,
    ymax = 1;

var margins = [50, 30, 50, 10], mb = margins[0], ml = margins[1], mt = margins[2], mr = margins[3];
var w = width - (ml + mr),
    h = height - (mb + mt);
var x = d3.scale.linear().range([0, w]).domain([0,xmax]);
var y = d3.scale.linear().range([0, h]).domain([0,ymax]);

// Add chart SVG
var svg = d3.select('#chart').append('svg:svg')
    .attr('class', 'chart')
    .attr("width", width)
    .attr("height", height);
var plot = svg.append('g').attr('id','plot').attr('transform','translate('+ml+','+mt+')');
var dataRegion = plot.append('g').attr('id','data-region');

var controls = d3.selectAll('#controls button')
    .data(['Go !','Reset']);

// Deal with 'Go' button clicks
controls.filter(function(d,i) { return i == 0; })
    .on('click',function(w) {
        // Only run ponies if there is at least one to run!
        if (ponies.length > 0)
        {
            if (!running && !done) {
                running = true;
                d3.selectAll('#controls button').filter(function(d,i) { return i == 0;}).text('Pause');
                document.getElementById('name').disabled = true;
                document.getElementById('num').disabled = true;
                allowChanging = false;
                runPonies();
            } else if (!done) {
                running = false;
                d3.selectAll('#controls button').filter(function(d,i) { return i == 0;}).text('Go!');
            }
        } else {
            window.alert('You have to have at least one jockey racing!')
        }
    });

// Deal with 'Reset' button clicks
controls.filter(function(d,i) { return i == 1; })
    .on('click',function(w) {
        document.getElementById('name').disabled = false;
        document.getElementById('num').disabled = false;
        allowChanging = true;
        resetPonies();
        });

// Add the start and finish lines
d3.select('#data-region').selectAll('.border-line')
        .data([10, 100])
    .enter()
        .append('svg:line')
        .classed('border-line',true)
        .attr('x1',function(d) { return x(d); })
        .attr('x2',function(d) { return x(d); })
        .attr('y1',y(0))
        .attr('y2',y(ymax))
        .style('stroke','black')
        .style('stroke-dasharray','10,10');

$(window).resize(function() {
    // Add in limits at which points we don't get smaller than
    width = $(window).width()-275;
    height = $(window).height()-150;

    w = width - (ml + mr);
    h = height - (mb + mt);
    x = d3.scale.linear().range([0, w]).domain([0,xmax]);
    y = d3.scale.linear().range([0, h]).domain([0,ymax]);

    d3.select('#chart').select('svg.chart')
        .attr("width", width)
        .attr("height", height);

    d3.select('#data-region').selectAll('.border-line')
        .attr('x1',function(d) { return x(d); })
        .attr('x2',function(d) { return x(d); })
        .attr('y1',y(0))
        .attr('y2',y(ymax));

    updatePonyLineup();
});
        </script>
    </body>
</html>
