<html>
    <head>
        <title>Carnival-style pony-race drawing</title>
        <link type="text/css" rel="stylesheet" href="button.css">
        <link type="text/css" rel="stylesheet" href="charts.css">
        <link rel="stylesheet" type="text/css" href="libs/jquery-simplecolorpicker/jquery.simplecolorpicker.css"/>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="libs/jquery-ui.toggleSwitch/jquery-ui.toggleSwitch.css">
        <link href='http://fonts.googleapis.com/css?family=Kite+One' rel='stylesheet' type='text/css'>

        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script language="javascript" type="text/javascript" src="pony-race.js"></script>
        <script language="javascript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
        <script language="javascript" type ="text/javascript" src="libs/jquery-simplecolorpicker/jquery.simplecolorpicker.js"></script>
        <script language="javascript" type ="text/javascript" src="libs/jquery-ui.toggleSwitch/jquery-ui.toggleSwitch.js"></script>
        
        <style>
svg { 
    background: rgb(191,168,114);
    border:2px solid;
    border-radius: 30px;
    box-shadow: 5px 5px 10px #999999;
}

h1 { text-align: center; }

h2 {
    font-family: 'Kite One', sans-serif;
    font-size: 1.25em;
    margin-top: .3em;
    margin-bottom: .3em;
}


body, p, span, input,button { font-family: 'Kite One'; }

span { font-size: .9em; }

#left-col {
    width: 200px;
    float: left;
}

#right-col {
    margin-left: 200px;
    position: relative;
}

.clear { 
    clear: both;
}

.jockey-name {
    display: inline;
    width: 120px;
    margin-right: 2px;
}

.jockey-num {
    display: inline;
    width: 30px;
    margin-right: 2px;
    margin-left: 4px;
}

.jockey-col {
    margin-left: 4px;
}

.inputs-text {
   width: 200px;
   float: left;
}

#center-add-button {
    display: inline;
}

#inputs-other {
   margin-left: 130px;
   padding-top: 1px;
}

#adv-options { 
    margin-top: 10px;
    margin-left: 10px;
    margin-right: 10px;
    padding-top: 10px;
    border-top: 1px solid black;
    text-align: center;
}

#controls { 
    margin-top: 10px;
    margin-left: 10px;
    margin-right: 10px;
    padding-top: 10px;
    border-top: 1px solid black;
    text-align: center;
}

.edited-input {
    color: black;
}

.default-input {
    color: #999;
}

#add-jockey,
.jockey-remove {
    padding-left: 4px;
    width: 10px;
    text-align: center;
    display: inline;
    cursor: pointer;
}

#adv-options-expand {
    display: none;
}
        </style>
    </head>
    <body>
        <h1>Pony Race!</h1>
          <div id="container">
            <div id="left-col">
              <div id="jockey-list-cont">
                  <h2>Jockeys</h2>
                  <div class="inputs-text" id="jockey-list">
                  </div>
              </div>
              <div id="inputs">
                  <div class="inputs-text">
                      <input type="text" id="name" class="jockey-name
                      default-input"
                      value="Jockey"/><input type="text" id="num" class="jockey-num
                      default-input" value="#"/>
                    <select name="colorpicker" id="colorpicker">
                      <!-- Colors from ColorBrewer2.org  -->
                      <option value="#1F78B4">Blue</option>
                      <option value="#33A02C">Green</option>
                      <option value="#E31A1C">Red</option>
                      <option value="#FF7F00">Orange</option>
                      <option value="#6A3D9A">Purple</option>
                      <option value="#A6CEE3">Light Blue</option>
                      <option value="#B2DF8A">Light Green</option>
                      <option value="#FB9A99">Light Red</option>
                      <option value="#FDBF6F">Light Orange</option>
                      <option value="#CAB2D6">Light Purple</option>
                    </select><span id="add-jockey" onclick="addEntrant()">+</span>
                  </div>
                  <div class="clear"></div>
              </div>
              <div id="adv-options">
                  <span onclick="expandAdvOptions()" id="adv-options-title">+ Show Advanced Options</span>
                  <div id="adv-options-expand">
                      <span>Speed:</span><input type="range" id="race-speed" name="race-speed" min="0" max="20"
                      value="10" onChange="updateSpeed()">
                      <div id='race-dir-toggle-containter'>
                          <select id='race-dir-toggle' class='ui-toggle-switch
                              race-dir-toggle'>
                              <option>Left</option>
                              <option>Right</option>
                          </select>
                      </div>

                      <div id='randomizee-toggle-containter'>
                          <select id='randomize-toggle' class='ui-toggle-switch
                              randomize-toggle'>
                              <option>Sorted</option>
                              <option>Random</option>
                          </select>
                      </div>

                  </div>
              </div>
              <div id="controls">
                  <button id="go-button" class="first last" onclick="runButtonClick()">Go!</button>
                  <button id="pause-button" class="first last" onclick="resetButtonClick()">Reset</button>
              </div>
            </div>
            <div id="right-col">

              <div id="chart">
              </div>

              <div id="winner-list" title="Race Results">
              </div>
            </div>
            <div class="clear"></div>
          </div>

        <script type="text/javascript">


var updateStartDir = function(which) {
    if (which === "Left") {
//        x = d3.scale.linear().range([0, w]).domain([0,xmax]);
        d3.select('#plot').transition().duration(1000).attr('transform','translate('+ml+','+mt+') scale(1,1)');
    } else {
        d3.select('#plot').transition().duration(1000).attr('transform','translate('+(w+ml)+','+mt+') scale(-1,1)');
//        x = d3.scale.linear().range([w, 0]).domain([0,xmax]);
    }

//    d3.select('#data-region').selectAll('.border-line')
//        .transition().duration(1250)
//        .attr('x1',function(d) { return x(d); })
//        .attr('x2',function(d) { return x(d); })
//        .attr('y1',y(0))
//        .attr('y2',y(ponies.length));

//    updatePonyLineup();
}


var processEnter = function(e) {
    if (e.which == 13) {
        addEntrant();
        e.preventDefault();
    }
}

$('input[id=num]').on('keypress',function(e) { return processEnter(e); });
$('input[id=name]').on('keypress',function(e) { return processEnter(e) });

var colorList = [{value:"#1F78B4", name:'Blue', active:1},
                {value:"#33A02C", name:'Green', active:1},
                {value:"#E31A1C", name:'Red', active:1},
                {value:"#FF7F00", name:'Orange', active:1},
                {value:"#6A3D9A", name:'Purple', active:1},
                {value:"#A6CEE3", name:'Light Blue', active:1},
                {value:"#B2DF8A", name:'Light Green', active:1},
                {value:"#FB9A99", name:'Light Red', active:1},
                {value:"#FDBF6F", name:'Light Orange', active:1},
                {value:"#CAB2D6", name:'Light Purple', active:1}];


var updatePicker = function() {
    // Add the color picker
    $('select[name="colorpicker"]').empty();
    var firstCol = '';
    for (var i = 0; i < colorList.length; i++) {
        if (colorList[i].active) {
            if (firstCol == '') {
                firstCol = colorList[i].value;
            }
            var option = $('<option></option')
                    .attr("value",colorList[i].value)
                    .text(colorList[i].name);
            $('select[name="colorpicker"]').append(option);
        }
    }

    $('select[name="colorpicker"]').simplecolorpicker();
    $('select[name="colorpicker"]').simplecolorpicker('selectColor',firstCol);
    $('select[name="colorpicker"]').simplecolorpicker('destroy');
    $('select[name="colorpicker"]').simplecolorpicker({picker: true});
};

updatePicker();

// Have default values in form disappear on focus
// From http://stackoverflow.com/a/12876076
var formDefaulter=function(){
    //Class to hold each form element
    var FormElement=function(element){
        var that=this;
        this.element=element;

        var initialVal=this.element.val();
        var isEdited=false;

        this.element.focus(function(){clearBox()});
        this.element.blur(function(){fillBox()});

        var clearBox=function(){
            if(!isEdited){
                that.element.val("");
                that.element.addClass("edited-input");
                that.element.removeClass("default-input");
                isEdited=true;
            }
        }
        var fillBox=function(){
            if(that.element.val()==""){
                that.element.val(initialVal);
                that.element.removeClass("edited-input");
                that.element.addClass("default-input");
                isEdited=false;
            }
        }
    }

    var add=function(elementId){
        new FormElement($('#'+elementId));
    }

    return{
        add:add
    }
}();

$(function(){
    formDefaulter.add('name');
    formDefaulter.add('num');
});

var updateSpeed = function() {
    raceLength = 21-$('#race-speed').val();
    console.log(raceLength);
}

var ponies = [];
var jockeys = [];
var random = false;

var type = 'bike';
//var type = 'shape';
//var type = 'pony';

var nextPlace = 1;
var raceLength = 10; // Race length in seconds

var running = false;
var done = false;
var allowChanging = true;
var advOptionsHidden = true;

var width = $(window).width()-275;
    height = $(window).height()-150;

var xmax = 110;

var margins = [50, 30, 50, 30], mb = margins[0], ml = margins[1], mt = margins[2], mr = margins[3];
var w = width - (ml + mr),
    h = height - (mb + mt);
var x = d3.scale.linear().range([0, w]).domain([0,xmax]);
var y = d3.scale.linear().range([0, h]).domain([0,1]);

// Add chart SVG
var svg = d3.select('#chart').append('svg:svg')
    .attr('class', 'chart')
    .attr("width", width)
    .attr("height", height);

var defs = svg.append('defs');
var plot = svg.append('g').attr('id','plot').attr('transform','translate('+ml+','+mt+')');
var dataRegion = plot.append('g').attr('id','data-region');

var runButtonClick = function() {
        // Only run ponies if there is at least one to run!
        if (ponies.length > 0)
        {
            if (!running && !done) {
                running = true;
                $("#go-button").text('Pause');
                $("#name").prop('disabled', true);
                $("#num").prop('disabled', true);
                allowChanging = false;
                runPonies();
            } else if (!done) {
                running = false;
                $("#go-button").text('Go!');
            }
        } else {
            window.alert('You have to have at least one jockey racing!')
        }
}

// Deal with 'Reset' button clicks
var resetButtonClick = function() {
    $("#name").prop('disabled', false);
    $("#num").prop('disabled', false);
    allowChanging = true;
    resetPonies();
};


// Add the start and finish lines
d3.select('#data-region').selectAll('.border-line')
        .data([10, 100],function(d) { return d; })
    .enter()
        .append('svg:line')
        .classed('border-line',true)
        .attr('x1',function(d) { return x(d); })
        .attr('x2',function(d) { return x(d); })
        .attr('y1',y(0))
        .attr('y2',y(1))
        .style('stroke','black')
        .style('stroke-dasharray','10,10');

$(window).resize(function() {
    // Add in limits at which points we don't get smaller than
    width = $(window).width()-275;
    height = $(window).height()-150;

    w = width - (ml + mr);
    h = height - (mb + mt);
    x = d3.scale.linear().range([0, w]).domain([0,xmax]);
    y = d3.scale.linear().range([0, h]).domain([0,ponies.length > 0 ?
        ponies.length : 1]);

    d3.select('#chart').select('svg.chart')
        .attr("width", width)
        .attr("height", height);

    d3.select('#data-region').selectAll('.border-line')
        .attr('x1',function(d) { return x(d); })
        .attr('x2',function(d) { return x(d); })
        .attr('y1',y(0))
        .attr('y2',y(ponies.length > 0 ? ponies.length : 1));

    updatePonyLineup();
});

$("#race-dir-toggle").toggleSwitch({
            highlight: false,
            change: function(e) {
                if (ponies.length > 0) {
                    updateStartDir($('#race-dir-toggle').val());
                }
              },
        });

$("#randomize-toggle").toggleSwitch({
            highlight:false,
            change: function(e) {
                if (ponies.length > 0) {
                    randomizePonies($('#randomize-toggle').val());
                }
              },
        });

var bike = '';

d3.xml("road.svg", "image/svg+xml", function(xml) {  
  var importedNode = document.importNode(xml.documentElement, true);
  defs.append("g")
            .attr('id','road-bike')
            .attr('transform','translate(-551,-156)')
        .each(function(d, i){ 
            var plane = this.appendChild(importedNode.cloneNode(true)); 
        });
});

d3.xml("pony.svg", "image/svg+xml", function(xml) {  
  var importedNode = document.importNode(xml.documentElement, true);
  defs.append("g")
            .attr('id','race-pony')
            .attr('transform','translate(-605,-235)')
        .each(function(d, i){ 
            var plane = this.appendChild(importedNode.cloneNode(true)); 
        });
});

        </script>
    </body>
</html>
